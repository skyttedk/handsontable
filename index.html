<!DOCTYPE html>
<html lang="en">
<!-- https://handsontable.com/docs/8.3.2/tutorial-quick-start.html -->
<!-- https://handsontable.com/docs/8.3.2/tutorial-load-and-save.html -->
<!--
  reload entire row when selectde<-niiice
  reload field when selected  <- niiice !
  show errors and messages <-nice
  non editable fields--shouldnot be editable
  
  ERROR: Når man tagger, triggers afterSelection før onchange !! -- det er ærgeligt.!


  Could we create runtime updates on every field (you know realtime !!) ???
  //Der er noget galt med date time felter...

  create a json editor...
  other customer editors ???

-->

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <script src="https://code.jquery.com/jquery-3.5.0.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/erpify-connector/erpify-connector.js"></script>
  <script type="text/javascript" src="js/window.factory.js"></script>
  <script type="text/javascript" src="js/ext-all-debug.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@8.3.2/dist/handsontable.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/handsontable@8.3.2/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="css/ext-theme-gray-all.css" />  


  <script>
    async function onload() {
      //erpify = new window.ErpifyConnector()
      //erpify.debug = true
      //erpify.setLanguageCode('ENG');


      let win= new WindowFactory();
			win.init();

      /*
      //Connect
      await erpify.connect('http://localhost:22222', 'skytte_dk', 'dit5740')


      let modelPackage = await erpify.sendRequest("Server", "getModels", {})
      $('#models').empty();
      $.each(modelPackage.response.data, async function (i, p) {
        $('#models').append($('<option></option>').val(p).html(p));
      });


      $("#models").change(async function () {
        loadModel($('#models').val())
      });

      //Load default model
      $("#models").val("User");
      loadModel($('#models').val())


      async function loadModel(modelName) {

        let schemaPackage = await erpify.sendRequest("Data", "getSchemaHandson", {
          "modelName": modelName
        })

        let dataPackage = await erpify.sendRequest("Data", "loadRecordSet", {
          "modelName": modelName,
          "filter": "",
          "paging": ""
        })





        $('#dataGrid').empty();

        const container = document.getElementById('dataGrid');
        const hot = new Handsontable(container, {
          data: dataPackage.response.data.rows,
          colHeaders: schemaPackage.response.data.captions,
          columns: schemaPackage.response.data.columns,
          rowHeaders: true,
          //stretchH: 'all',
          autoWrapRow: true,
          filters: true,
          dropdownMenu: true,

          columnSorting: {
            indicator: true,
            sortEmptyCells: false,
            initialConfig: {
              column: 0,
              sortOrder: 'asc'
            }
          },

          minSpareRows: 1,
          width: 806,
          contextMenu: false,
          licenseKey: 'non-commercial-and-evaluation',
          beforeChange: async function (change, source) {
            if (source === 'loadData') {
              return; //don't save this change
            }
            if (source === 'edit') {
              const rowIndex = change[0][0]
              const columnName = change[0][1]
              const oldValue = change[0][2]
              const newValue = change[0][3]
              const row = hot.getSourceData()[0]
              if (oldValue != newValue) {
                console.log("before Change")
                // Update field on server
                try {
                  let package = await erpify.sendRequest("Data", "updateField", {
                    "modelName": $('#models').val(),
                    "id": row.id,
                    "columnName": columnName,
                    "value": newValue
                  })

                } catch (error) {
                  $('#errorLabel').text(`Error(${error.response.systemLogId}): ` + error.response.message);
                  reloadRow(hot,rowIndex)
                  setTimeout(() => $('#errorLabel').text(''), 3000)
                }

              }
            }

          },
          afterSelection: async (row, column, row2, column2, preventScrolling, selectionLayerLevel) => {
            // setting if prevent scrolling after selection
            if (row > -1) {
              console.log("afterSelectionByProp")
              reloadRow(hot,row)
              preventScrolling.value = true;
            }
          },
          afterRemoveRow: () => console.log("remove")
        });

        //const filtersPlugin = hot.getPlugin('filters');
        //filtersPlugin.addCondition(0, 'gt', [1]);
        //filtersPlugin.filter();

      }


      document.getElementById('dataGrid').setAttribute("style", 'display: block');

*/
    }
    /*
    async function reloadRow(hot, index) {//const selectedRow = hot.getSourceData()[row] //Original data
      //const selectedRow = hot.getSourceData()[row] //Original data
      const selectedRow = hot.getData()[index] //Current Data(Filtered and sorted)
      const id = selectedRow[0]
      let package = await erpify.sendRequest("Data", "getRecord", {
        "modelName": $('#models').val(),
        "id": id,
      })
      const record = package.response.data
      const recordArray = []
      for (const [key, value] of Object.entries(record)) {
        var recordField = [index, key, value]
        recordArray.push(recordField)
      }
      hot.setDataAtRowProp(recordArray)
    }
    */
  </script>
</head>

<body onload="onload();">


</body>

</html>