


  <script>

    window.hot = {}

    window.previousRow = -1
    window.previousColumn = -1
    window.previousValue = null

    window.currentRow = -1
    window.currentColumn = -1
    window.currentValue = null

    async function onload() {

      erpify = new window.ErpifyConnector()
      erpify.debug = true
      erpify.setLanguageCode('ENG');


      //Connect
      await erpify.connect('http://localhost:22222', 'skytte_dk', 'dit5740')


      let modelPackage = await erpify.sendRequest("Server", "getModels", {})
      $('#models').empty();
      $.each(modelPackage.response.data, async function (i, p) {
        $('#models').append($('<option></option>').val(p).html(p));
      });


      $("#models").change(async function () {
        loadModel($('#models').val())
      });

      //Load default model
      $("#models").val("User");
      loadModel($('#models').val())


      async function loadModel(modelName) {

        let schemaPackage = await erpify.sendRequest("Data", "getSchemaHandson", {
          "modelName": modelName
        })

        //console.log(schemaPackage);
        //for (var column of schemaPackage.response.data.columns) {
        //  console.log(column)
        //  
        //}

        let dataPackage = await erpify.sendRequest("Data", "loadRecordSet", {
          "modelName": modelName,
          "filter": "",
          "paging": ""
        })


        $('#dataGrid').empty();

        const container = document.getElementById('dataGrid');
        window.hot = new Handsontable(container, {
          data: dataPackage.response.data.rows,
          colHeaders: schemaPackage.response.data.captions,
          columns: schemaPackage.response.data.columns,
          rowHeaders: true,
          //stretchH: 'all',
          autoWrapRow: true,
          filters: true,
          dropdownMenu: true,

          columnSorting: {
            indicator: true,
            sortEmptyCells: false,
            initialConfig: {
              column: 0,
              sortOrder: 'asc'
            }
          },
          tabMoves11: async function (event) {


            //await hot.runHooks('afterChange');
            //console.log(event)
            return { row: 0, col: 1 };
          },
          minSpareRows: 1,
          width: 806,
          contextMenu: false,
          licenseKey: 'non-commercial-and-evaluation',
          afterChange: async function (change, source) {
            if (source === 'loadData') {
              return; //don't save this change
            }
            if (source === 'edit' || source === undefined) {
              const rowIndex = change[0][0]
              const columnName = change[0][1]
              const oldValue = change[0][2]
              const newValue = change[0][3]
              
              const row = window.hot.getData()[rowIndex]

              if (oldValue != newValue) {
                // Update field on server
                try {
                  let package = await erpify.sendRequest("Data", "updateField", {
                    "modelName": $('#models').val(),
                    "id": row[0],
                    "columnName": columnName,
                    "value": newValue
                  })

                } catch (error) {
                  $('#errorLabel').text(`Error(${error.response.systemLogId}): ` + error.response.message);
                  setTimeout(() => $('#errorLabel').text(''), 3000)
                }
                //Always fetch rowdata from server
                reloadRow(rowIndex)
              }
            }
          },
          afterSelection: async (row, column, row2, column2, preventScrolling, selectionLayerLevel) => {


            if (row > -1) {
             // preventScrolling.value = true;
            }
          },
          afterRemoveRow: () => console.log("remove")
        });

        //const filtersPlugin = hot.getPlugin('filters');
        //filtersPlugin.addCondition(0, 'gt', [1]);
        //filtersPlugin.filter();

      }


      document.getElementById('dataGrid').setAttribute("style", 'display: block');


    }


    async function reloadRow(index) {//const selectedRow = hot.getSourceData()[row] //Original data
      //const selectedRow = hot.getSourceData()[row] //Original data
      const selectedRow = window.hot.getData()[index] //Current Data(Filtered and sorted)
      const id = selectedRow[0]
      let package = await erpify.sendRequest("Data", "getRecord", {
        "modelName": $('#models').val(),
        "id": id,
      })
      const record = package.response.data
      const recordArray = []
      for (const [key, value] of Object.entries(record)) {
        var recordField = [index, key, value]
        recordArray.push(recordField)
      }
      hot.setDataAtRowProp(recordArray)
    }

    //
    function customDropDownRender(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.AutocompleteRenderer.apply(this, arguments);
      var ddsource = ['Select', 'opt1', 'opt2', 'opt3', 'opt4'];
      cellProperties.data = 'options',
        cellProperties.type = 'dropdown';
      cellProperties.source = ddsource;
    }
  </script>




  <label for="models" style="display: inline-block;width:100px">Model</label>
  <select id="models" style="width:200px;margin-bottom:20px"></select>
  <br>

  <div id="dataGrid"></div>
  <span id="errorLabel" style="color:red"></span>
  
	<script>onload();</script>



