<!DOCTYPE html>
<html lang="en">
<!-- https://handsontable.com/docs/8.3.2/tutorial-quick-start.html -->
<!-- https://handsontable.com/docs/8.3.2/tutorial-load-and-save.html -->
<!--
  reload entire row when selectde - ok
  reload field when selected  - ok
  show errors and messages - ok
  alignment based on datatype - ok
  ERROR: Når man tagger, triggers afterSelection før onchange - ok
  non editable fields--shouldnot be editable - ok 
  delete row - ok


  deleteknap på row... den nuller alle fields, det skal den ikke . den skal slettes

  sletning af flere rows...


  insert row

  opdatering af fleres records, med sideeffects som ikke virkere med bulkupdate.

  // Når vi får response fra server, ifm. update behøver vi ikke hent current row, da vi jo får den med tilbage me det samnme.
  derfor skal updateRow, skilles af i en getRecoredFromServer, UpdateRow, og en ConvertErpifyRecordToHendsonRecord




  Time / date felter  vises kuin noge bganel

  Json, custom editer
  test , custom editor
  opslag i relatedere tabeller med handsontable

  Could we create runtime updates on every field (you know realtime !!) ???
  //Der er noget galt med date time felter...

  create a json editor...
  other customer editors ???

-->

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <script src="https://code.jquery.com/jquery-3.5.0.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/erpify-connector/erpify-connector.js"></script>
  <script type="text/javascript" src="js/window.factory.js"></script>
  <script type="text/javascript" src="js/ext-all-debug.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@8.3.2/dist/handsontable.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/handsontable@8.3.2/dist/handsontable.full.min.css" rel="stylesheet"
    media="screen">
  <link rel="stylesheet" href="css/ext-theme-gray-all.css" />


  <script>

    window.hot = {}

    window.previousRow = -1
    window.previousColumn = -1
    window.previousValue = null

    window.currentRow = -1
    window.currentColumn = -1
    window.currentValue = null

    async function onload() {

      erpify = new window.ErpifyConnector()
      erpify.debug = true
      erpify.setLanguageCode('ENG');


      //Connect
      await erpify.connect('http://localhost:22222', 'skytte_dk', 'dit5740')


      let modelPackage = await erpify.sendRequest("Server", "getModels", {})
      $('#models').empty();
      $.each(modelPackage.response.data, async function (i, p) {
        $('#models').append($('<option></option>').val(p).html(p));
      });


      $("#models").change(async function () {
        loadModel($('#models').val())
      });

      //Load default model
      $("#models").val("User");
      loadModel($('#models').val())


      async function loadModel(modelName) {

        let schemaPackage = await erpify.sendRequest("Data", "getSchemaHandson", {
          "modelName": modelName
        })

        //console.log(schemaPackage);
        //for (var column of schemaPackage.response.data.columns) {
        //  console.log(column)
        //  
        //}

        let dataPackage = await erpify.sendRequest("Data", "loadRecordSet", {
          "modelName": modelName,
          "filter": "",
          "paging": ""
        })


        $('#dataGrid').empty();

        const container = document.getElementById('dataGrid');
        window.hot = new Handsontable(container, {
          data: dataPackage.response.data.rows,
          colHeaders: schemaPackage.response.data.captions,
          columns: schemaPackage.response.data.columns,
          rowHeaders: true,
          //stretchH: 'all',
          autoWrapRow: true,
          filters: true,
          dropdownMenu: true,
          contextMenu: ['remove_row'],
          licenseKey: 'non-commercial-and-evaluation',
          columnSorting: {
            indicator: true,
            sortEmptyCells: false,
            initialConfig: {
              column: 0,
              sortOrder: 'asc'
            }
          },
          tabMoves11: async function (event) {


            //await hot.runHooks('afterChange');
            //console.log(event)
            return { row: 0, col: 1 };
          },
          minSpareRows: 1,
          width: 806,

          beforeRemoveRow: async function (index, amount, physicalRows, source) {
            const row = window.hot.getData()[index]
            try {
                  let package = await erpify.sendRequest("Data", "deleteRecord", {
                    "modelName": $('#models').val(),
                    "id": row[0]
                  })

                } catch (error) {
                  $('#errorLabel').text(`Error(${error.response.systemLogId}): ` + error.response.message);
                  setTimeout(() => $('#errorLabel').text(''), 3000)
                }

          },
          afterRemoveRow: () => console.log(""),
          afterChange: async function (change, source) {
            if (source === 'loadData') {
              return; //don't save this change
            }
            if (source === 'edit' || source === undefined) {
              const rowIndex = change[0][0]
              const columnName = change[0][1]
              const oldValue = change[0][2]
              const newValue = change[0][3]

              const row = window.hot.getData()[rowIndex]

              if (oldValue != newValue) {
                // Update field on server
                try {
                  let package = await erpify.sendRequest("Data", "updateField", {
                    "modelName": $('#models').val(),
                    "id": row[0],
                    "columnName": columnName,
                    "value": newValue
                  })

                } catch (error) {
                  $('#errorLabel').text(`Error(${error.response.systemLogId}): ` + error.response.message);
                  setTimeout(() => $('#errorLabel').text(''), 3000)
                }
                //Always fetch rowdata from server
                reloadRow(rowIndex)
              }
            }
          },
          afterSelection: async (row, column, row2, column2, preventScrolling, selectionLayerLevel) => {


            if (row > -1) {
              // preventScrolling.value = true;
            }
          },
          
        });

        //const filtersPlugin = hot.getPlugin('filters');
        //filtersPlugin.addCondition(0, 'gt', [1]);
        //filtersPlugin.filter();

      }


      document.getElementById('dataGrid').setAttribute("style", 'display: block');


    }


    async function reloadRow(index) {//const selectedRow = hot.getSourceData()[row] //Original data
      //const selectedRow = hot.getSourceData()[row] //Original data
      const selectedRow = window.hot.getData()[index] //Current Data(Filtered and sorted)
      const id = selectedRow[0]
      let package = await erpify.sendRequest("Data", "getRecord", {
        "modelName": $('#models').val(),
        "id": id,
      })
      const record = package.response.data
      const recordArray = []
      for (const [key, value] of Object.entries(record)) {
        var recordField = [index, key, value]
        recordArray.push(recordField)
      }
      hot.setDataAtRowProp(recordArray)
    }

    //
    function customDropDownRender(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.AutocompleteRenderer.apply(this, arguments);
      var ddsource = ['Select', 'opt1', 'opt2', 'opt3', 'opt4'];
      cellProperties.data = 'options',
        cellProperties.type = 'dropdown';
      cellProperties.source = ddsource;
    }
  </script>
</head>

<body onload="onload();">

  <label for="models" style="display: inline-block;width:100px">Model</label>
  <select id="models" style="width:200px;margin-bottom:20px"></select>
  <br>

  <div id="dataGrid"></div>
  <span id="errorLabel" style="color:red"></span>


</body>

</html>